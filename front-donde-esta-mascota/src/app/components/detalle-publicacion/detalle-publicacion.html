<div class="detalle-container">
  
  <!-- Bot√≥n volver -->
  <button class="btn-volver" (click)="volver()">
    ‚Üê Volver al listado
  </button>

  <!-- Loading -->
  <div *ngIf="cargando" class="mensaje-carga">
    <p>Cargando publicaci√≥n...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error && !cargando" class="mensaje-error">
    <p>{{ error }}</p>
    <button (click)="volver()">Volver al listado</button>
  </div>

  <!-- Contenido de la publicacion -->
  <div *ngIf="publicacion && !cargando" class="detalle-content">
    
    <!-- Layout con grid para contenido principal y panel lateral -->
    <div class="detalle-layout">
      
      <!-- Contenido principal (izquierda) -->
      <div class="contenido-principal">
        
        <!-- Encabezado -->
        <div class="detalle-header">
          <h1>{{ publicacion.nombre }}</h1>
          <span class="estado-badge" [ngClass]="'estado-' + publicacion.estado">
            {{ publicacion.estado }}
          </span>
        </div>

        <!-- Galer√≠a de im√°genes -->
        <div class="galeria-container" *ngIf="publicacion.imagenes64 && publicacion.imagenes64.length > 0">
          
          <!-- Imagen principal -->
          <div class="imagen-principal-container">
            <img 
              [src]="publicacion.imagenes64[imagenActualIndex]" 
              [alt]="publicacion.nombre" 
              class="imagen-principal">
            
            <!-- Botones de navegaci√≥n (solo si hay m√°s de 1 imagen) -->
            <button 
              *ngIf="publicacion.imagenes64.length > 1 && imagenActualIndex > 0"
              class="nav-btn nav-btn-izq" 
              (click)="imagenAnterior()">
              ‚Äπ
            </button>
            <button 
              *ngIf="publicacion.imagenes64.length > 1 && imagenActualIndex < publicacion.imagenes64.length - 1"
              class="nav-btn nav-btn-der" 
              (click)="imagenSiguiente()">
              ‚Ä∫
            </button>
            
            <!-- Contador de im√°genes -->
            <div class="contador-imagenes" *ngIf="publicacion.imagenes64.length > 1">
              {{ imagenActualIndex + 1 }} / {{ publicacion.imagenes64.length }}
            </div>
          </div>

          <!-- Miniaturas (thumbnails) -->
          <div class="thumbnails-container" *ngIf="publicacion.imagenes64.length > 1">
            <div 
              *ngFor="let imagen of publicacion.imagenes64; let i = index"
              class="thumbnail"
              [class.thumbnail-activa]="i === imagenActualIndex"
              (click)="seleccionarImagen(i)">
              <img [src]="imagen" [alt]="'Imagen ' + (i + 1)">
            </div>
          </div>
        </div>

        <div *ngIf="!publicacion.imagenes64 || publicacion.imagenes64.length === 0" class="sin-imagen-detalle">
          <p>üì∑ Sin im√°genes disponibles</p>
        </div>

        <!-- Informaci√≥n principal -->
        <div class="info-grid">
          <div class="info-card">
            <h3>Informaci√≥n de la mascota</h3>
            <p><strong>Color:</strong> {{ publicacion.color }}</p>
            <p><strong>Tama√±o:</strong> {{ publicacion.tamanio || 'No especificado' }}</p>
            <p><strong>Fecha:</strong> {{ publicacion.fecha }}</p>
            <p><strong>Descripci√≥n:</strong> {{ publicacion.descripcion }}</p>
          </div>

          <div class="info-card">
            <h3>Ubicaci√≥n</h3>
            <p><strong>Provincia:</strong> {{ publicacion.provincia }}</p>
            <p><strong>Localidad:</strong> {{ publicacion.localidad }}</p>
            <p><strong>Calle:</strong> {{ publicacion.calle }} {{ publicacion.altura }}</p>
            <button type="button" class="btn-ver-mapa" (click)="abrirModalMapa()">
              <span>üìç</span> Ver Mapa y Avistamientos
            </button>
          </div>

          <div class="info-card" *ngIf="publicacion.autor">
            <h3>Contacto</h3>
            <p><strong>Nombre:</strong> {{ publicacion.autor.nombre }} {{ publicacion.autor.apellido }}</p>
            <p><strong>Tel√©fono:</strong> {{ publicacion.telefono }}</p>
            <p><strong>Email:</strong> {{ publicacion.autor.email }}</p>
          </div>
        </div>

        <!-- Boton de accion principal -->
        <div class="acciones-container">
          <button class="btn-accion btn-avistamiento" (click)="agregarAvistamiento()">
            Reportar un avistamiento
          </button>
        </div>

        <!-- avistamientos -->
        <div class="avistamientos-section" *ngIf="publicacion.avistamientos && publicacion.avistamientos.length > 0">
          <h3>Avistamientos reportados ({{ publicacion.avistamientos.length }})</h3>
          <div class="avistamiento-card" *ngFor="let avistamiento of publicacion.avistamientos">
            <p><strong>Fecha:</strong> {{ avistamiento.fecha }}</p>
            <p><strong>Descripci√≥n:</strong> {{ avistamiento.descripcion || 'Sin descripci√≥n' }}</p>
          </div>
        </div>

        <div *ngIf="!publicacion.avistamientos || publicacion.avistamientos.length === 0" class="sin-avistamientos">
          <p>A√∫n no hay avistamientos reportados para esta mascota</p>
        </div>

      </div>

      <!-- Panel lateral derecho (solo si es autor) -->
      <aside *ngIf="esAutor" class="panel-lateral">
        <div class="panel-contenido">
          <h3>Administrar publicaci√≥n</h3>
          <p class="panel-descripcion">Como autor de esta publicaci√≥n, pod√©s editarla o eliminarla.</p>
          
          <div class="panel-acciones">
            <button class="btn-panel btn-panel-editar" (click)="editarPublicacion()">
              <span class="icono"></span>
              <span>Editar publicaci√≥n</span>
            </button>
            
            <button 
              class="btn-panel btn-panel-eliminar" 
              (click)="eliminarPublicacion()"
              [disabled]="eliminando">
              <span class="icono"></span>
              <span>{{ eliminando ? 'Eliminando...' : 'Eliminar publicaci√≥n' }}</span>
            </button>
          </div>
        </div>
      </aside>

    </div>

  </div>
</div>

<!-- MODAL DE EDITAR -->
<div class="modal-overlay" *ngIf="mostrarModalEditar">
  <div class="modal-content">
    <button class="cerrar-modal" (click)="cerrarModalEditar()">√ó</button>
    <h2>Editar publicaci√≥n</h2>
    
    <form [formGroup]="editarForm" (ngSubmit)="guardarEdicion()">
      
      <!-- Nombre -->
      <div class="form-group">
        <label>Nombre <span class="required">*</span></label>
        <input 
          type="text" 
          formControlName="nombre"
          [class.error]="hasError('nombre', 'required') || hasError('nombre', 'minlength')" />
        <span class="error-message" *ngIf="editarForm.get('nombre')?.touched && editarForm.get('nombre')?.invalid">
          {{ getErrorMessage('nombre') }}
        </span>
      </div>

      <!-- Color -->
      <div class="form-group">
        <label>Color <span class="required">*</span></label>
        <input 
          type="text" 
          formControlName="color"
          [class.error]="hasError('color', 'required') || hasError('color', 'minlength')" />
        <span class="error-message" *ngIf="editarForm.get('color')?.touched && editarForm.get('color')?.invalid">
          {{ getErrorMessage('color') }}
        </span>
      </div>

      <!-- Tama√±o (SELECT) -->
      <div class="form-group">
        <label>Tama√±o <span class="required">*</span></label>
        <select 
          formControlName="tamanio"
          [class.error]="hasError('tamanio', 'required')">
          <option value="">Seleccion√° un tama√±o</option>
          <option *ngFor="let tamanio of opcionesTamanio" [value]="tamanio">
            {{ tamanio }}
          </option>
        </select>
        <span class="error-message" *ngIf="editarForm.get('tamanio')?.touched && editarForm.get('tamanio')?.invalid">
          {{ getErrorMessage('tamanio') }}
        </span>
      </div>

      <!-- Estado (SELECT CON REGLAS ACTUALIZADAS) -->
      <div class="form-group">
        <label>Estado <span class="required">*</span></label>
        <select 
          formControlName="estado"
          [class.error]="hasError('estado', 'required')">
          <option *ngFor="let estado of estadosPermitidos" [value]="estado.value">
            {{ estado.label }}
          </option>
        </select>
        <span class="error-message" *ngIf="editarForm.get('estado')?.touched && editarForm.get('estado')?.invalid">
          {{ getErrorMessage('estado') }}
        </span>
        
        <!-- Mensajes de ayuda contextuales seg√∫n el estado -->
        <small class="help-text" *ngIf="publicacion?.estado === 'PERDIDO_PROPIO'">
          ‚ÑπÔ∏è Pod√©s cambiar el estado a "Recuperado" si encontraste a tu mascota
        </small>
        <small class="help-text" *ngIf="publicacion?.estado === 'PERDIDO_AJENO'">
          ‚ÑπÔ∏è Pod√©s cambiar el estado a "Recuperado" o "Adoptado" seg√∫n corresponda
        </small>
        <small class="help-text help-text-warning" *ngIf="publicacion?.estado === 'RECUPERADO'">
          ‚ö†Ô∏è Si te equivocaste, pod√©s revertir el estado a "Perdido propio" o "Perdido ajeno"
        </small>
        <small class="help-text help-text-info" *ngIf="publicacion?.estado === 'ADOPTADO'">
          ‚úÖ El estado "Adoptado" es definitivo y no puede modificarse
        </small>
      </div>

      <!-- Descripci√≥n -->
      <div class="form-group">
        <label>Descripci√≥n <span class="required">*</span></label>
        <textarea 
          formControlName="descripcion" 
          rows="3"
          [class.error]="hasError('descripcion', 'required') || hasError('descripcion', 'minlength')">
        </textarea>
        <span class="error-message" *ngIf="editarForm.get('descripcion')?.touched && editarForm.get('descripcion')?.invalid">
          {{ getErrorMessage('descripcion') }}
        </span>
      </div>

      <!-- Tel√©fono -->
      <div class="form-group">
        <label>Tel√©fono <span class="required">*</span></label>
        <input 
          type="text" 
          formControlName="telefono"
          [class.error]="hasError('telefono', 'required') || hasError('telefono', 'pattern')" />
        <span class="error-message" *ngIf="editarForm.get('telefono')?.touched && editarForm.get('telefono')?.invalid">
          {{ getErrorMessage('telefono') }}
        </span>
      </div>

      <!-- Provincia (SELECT) -->
      <div class="form-group">
        <label>Provincia <span class="required">*</span></label>
        <select 
          formControlName="provincia"
          [class.error]="hasError('provincia', 'required')">
          <option value="">Seleccion√° una provincia</option>
          <option *ngFor="let provincia of opcionesProvincias" [value]="provincia">
            {{ provincia }}
          </option>
        </select>
        <span class="error-message" *ngIf="editarForm.get('provincia')?.touched && editarForm.get('provincia')?.invalid">
          {{ getErrorMessage('provincia') }}
        </span>
      </div>

      <!-- Localidad -->
      <div class="form-group">
        <label>Localidad <span class="required">*</span></label>
        <input 
          type="text" 
          formControlName="localidad"
          [class.error]="hasError('localidad', 'required') || hasError('localidad', 'minlength')" />
        <span class="error-message" *ngIf="editarForm.get('localidad')?.touched && editarForm.get('localidad')?.invalid">
          {{ getErrorMessage('localidad') }}
        </span>
      </div>

      <!-- Calle -->
      <div class="form-group">
        <label>Calle <span class="required">*</span></label>
        <input 
          type="text" 
          formControlName="calle"
          [class.error]="hasError('calle', 'required') || hasError('calle', 'minlength')" />
        <span class="error-message" *ngIf="editarForm.get('calle')?.touched && editarForm.get('calle')?.invalid">
          {{ getErrorMessage('calle') }}
        </span>
      </div>

      <!-- Altura -->
      <div class="form-group">
        <label>Altura <span class="required">*</span></label>
        <input 
          type="text" 
          formControlName="altura"
          [class.error]="hasError('altura', 'required') || hasError('altura', 'pattern')" />
        <span class="error-message" *ngIf="editarForm.get('altura')?.touched && editarForm.get('altura')?.invalid">
          {{ getErrorMessage('altura') }}
        </span>
      </div>

      <!-- Botones -->
      <div class="modal-botones">
        <button 
          type="submit" 
          class="btn-guardar" 
          [disabled]="editarForm.invalid || guardando">
          {{ guardando ? 'Guardando...' : 'Guardar cambios' }}
        </button>
        <button 
          type="button" 
          class="btn-cancelar" 
          (click)="cerrarModalEditar()"
          [disabled]="guardando">
          Cancelar
        </button>
      </div>

    </form>
  </div>
  <div class="modal-overlay-mapa" *ngIf="mostrarModalMapa">
    <div class="modal-content-mapa">
  
      <div class="modal-header">
        <h2>Ubicaci√≥n de {{ publicacion?.nombre }}</h2>
        <button class="cerrar-x" (click)="cerrarModalMapa()" title="Cerrar mapa">√ó</button>
      </div>
  
      <div class="map-wrapper">
        <app-mapa-detalle *ngIf="publicacion" [lat]="+(publicacion?.latitud ?? 0)" [lng]="+(publicacion?.longitud ?? 0)"
          [nombreMascota]="publicacion?.nombre || ''" [avistamientos]="publicacion?.avistamientos || []">
        </app-mapa-detalle>
      </div>
  
      <div class="modal-botones">
        <button type="button" class="btn-cancelar" style="width: 100%; margin-top: 15px;" (click)="cerrarModalMapa()">
          Cerrar Vista de Mapa
        </button>
      </div>
  
    </div>
  </div>
</div>