<div class="register-container">
  <mat-card>
    <h2>Crear Cuenta de Usuario</h2>

    <form [formGroup]="registerForm" (ngSubmit)="onSubmit()">
      <div class="photo-upload-container">
        <label>Foto de Perfil</label>

        <div class="profile-preview">
          <img
            *ngIf="profileImageBase64"
            [src]="profileImageBase64"
            alt="Vista Previa"
            class="preview-photo"
          />

          <mat-icon *ngIf="!profileImageBase64" class="placeholder-icon">person</mat-icon>
        </div>

        <div *ngIf="!profileImageBase64">
          <ngx-file-drop
            dropZoneLabel="Arrastra la foto aquí"
            accept="image/*"
            (onFileDrop)="dropped($event)"
            (onFileOver)="fileOver($event)"
            (onFileLeave)="fileLeave($event)"
          >
            <ng-template ngx-file-drop-content>
              <div class="drop-content">
                <mat-icon color="primary">cloud_upload</mat-icon>
                <p>Arrastra y suelta un archivo.</p>
                <input type="hidden" formControlName="imagen" />
              </div>
            </ng-template>
          </ngx-file-drop>

          <p style="margin: 15px 0; font-weight: bold">O</p>

          <input
            type="file"
            #fileInput
            accept="image/*"
            style="display: none"
            (change)="onFileSelected($event)"
          />

          <button mat-raised-button color="accent" type="button" (click)="fileInput.click()">
            <mat-icon>attach_file</mat-icon> Seleccionar Archivo
          </button>

          <mat-error *ngIf="!profileImageBase64 && imagen?.touched && imagen?.hasError('required')">
            La foto de perfil es requerida.
          </mat-error>
        </div>

        <button
          *ngIf="profileImageBase64"
          mat-button
          color="warn"
          (click)="profileImageBase64 = null; registerForm.get('imagen')?.setValue('')"
          type="button"
        >
          <mat-icon>delete</mat-icon> Quitar / Reemplazar Foto
        </button>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="nombre" />
        <mat-error *ngIf="nombre?.touched && nombre?.hasError('required')"
          >El nombre es obligatorio.</mat-error
        >
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Apellido</mat-label>
        <input matInput formControlName="apellido" />
        <mat-error *ngIf="apellido?.touched && apellido?.hasError('required')"
          >El apellido es obligatorio.</mat-error
        >
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>DNI</mat-label>
        <input matInput formControlName="dni" />
        <mat-error *ngIf="dni?.touched && dni?.hasError('required')"
          >El DNI es obligatorio.</mat-error
        >
        <mat-error *ngIf="dni?.touched && dni?.hasError('pattern')"
          >El DNI debe tener 7 a 9 dígitos.</mat-error
        >
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Teléfono</mat-label>
        <input matInput formControlName="telefono" />
        <mat-error *ngIf="telefono?.touched && telefono?.hasError('required')"
          >El teléfono es obligatorio.</mat-error
        >
        <mat-error *ngIf="telefono?.touched && telefono?.hasError('pattern')"
          >Formato de teléfono inválido.</mat-error
        >
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Email</mat-label>
        <input matInput formControlName="email" />
        <mat-error *ngIf="email?.touched && email?.hasError('required')"
          >El email es obligatorio.</mat-error
        >
        <mat-error *ngIf="email?.touched && email?.hasError('email')"
          >Formato de email inválido.</mat-error
        >
      </mat-form-field>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Provincia</mat-label>
        <input matInput formControlName="provincia" />
        <mat-error *ngIf="provincia?.touched && provincia?.hasError('required')"
          >La provincia es obligatoria.</mat-error
        >
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Localidad</mat-label>
        <input matInput formControlName="localidad" />
        <mat-error *ngIf="localidad?.touched && localidad?.hasError('required')"
          >La localidad es obligatoria.</mat-error
        >
      </mat-form-field>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Contraseña</mat-label>
        <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="password" />
        <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword" type="button">
          <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
        </button>
        <mat-error *ngIf="password?.touched && password?.hasError('required')"
          >La contraseña es obligatoria.</mat-error
        >
        <mat-error *ngIf="password?.touched && password?.hasError('minlength')"
          >La contraseña debe tener al menos 6 caracteres.</mat-error
        >
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Confirmar Contraseña</mat-label>
        <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirmPassword" />
        <button mat-icon-button matSuffix (click)="hideConfirmPassword = !hideConfirmPassword" type="button">
          <mat-icon>{{ hideConfirmPassword ? 'visibility_off' : 'visibility' }}</mat-icon>
        </button>
        <mat-error *ngIf="confirmPassword?.touched && confirmPassword?.hasError('required')">
          Confirme la contraseña.
        </mat-error>
        <mat-error *ngIf="confirmPassword?.touched && registerForm.hasError('passwordsMismatch')">
          Las contraseñas no coinciden.
        </mat-error>
      </mat-form-field>

      <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>

      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="registerForm.invalid"
        class="submit-button"
      >
        Registrarme
      </button>
    </form>

    <a [routerLink]="['/login']" class="login-link">¿Ya tienes una cuenta? Inicia sesión aquí.</a>
  </mat-card>
</div>
